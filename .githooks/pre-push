#!/bin/sh
command -v git-lfs >/dev/null 2>&1 || { echo >&2 "\nThis repository is configured for Git LFS but 'git-lfs' was not found on your path. If you no longer wish to use Git LFS, remove this hook by deleting the 'pre-push' file in the hooks directory (set by 'core.hookspath'; usually '.git/hooks').\n"; exit 2; }
git lfs pre-push "$@"

set -eu

find_npm_linux() {
  export NPM_CMD="npm"

  if ! (type $NPM_CMD >> /dev/null); then
    echo "npm not found, trying to make it available using nvm..."
    if type nvm >> /dev/null; then
      echo "nvm found, using it to install the latest lts node"
      nvm use --lts
    else
      echo "nvm not found, trying to make it available using the nvm.sh"
      # try to make it available based on https://github.com/typicode/husky/issues/912#issuecomment-817522060
      export NVM_DIR="$HOME/.nvm/nvm.sh"
      . "$(dirname $NVM_DIR)/nvm.sh"

      export NVM_DIR="$HOME/.nvm"
      a=$(nvm ls --no-colors | grep 'node')
      v=$(echo "$a" | sed -E 's/.*\(-> ([^ ]+).*/\1/')

      export PATH="$NVM_DIR/versions/node/$v/bin:$PATH"

      if ! (type $NPM_CMD >> /dev/null); then
        echo "no variant of npm or nvm found, trying to use the npm.cmd"
        export NPM_CMD="npm.cmd"
      fi
    fi
  fi
}

if [ -z "${OSTYPE+x}" ]; then
  find_npm_linux
else
  case "$OSTYPE" in
    msys*) export NPM_CMD="npm.cmd";;
    *)     find_npm_linux ;;
  esac
fi

reset() {
  echo "Cleaning up and return control"
  rm -r "$flowrtmpdir"
  cd "$curdir"
}

unclean=false
if [ -n "$(git status --porcelain)" ]; then
  # if we directly assign the test set -eu will not approve
  unclean=true
  trap reset EXIT
  echo "Working tree is not clean, so we reset in temporary folder"
  # backwards compatible platform independence
  flowrtmpdir=$(mktemp -d 2>/dev/null || mktemp -d -t 'flowrtmpdir')
  echo "Using temporary folder $flowrtmpdir"

  curdir=$(pwd)

  echo "Cloning copy..." # cloning obeys gitignore
  git clone . "$flowrtmpdir"
  echo "Keep installed packages..."
  cp -r node_modules/ "$flowrtmpdir/node_modules"
  cd "$flowrtmpdir"

  git reset --hard
  echo "Setup completed."
fi

echo "Linting project (local mode)..."
$NPM_CMD run lint-local


# shellcheck disable=SC2124 # we want the argument splitting
args="$@"
lfspre() {
  if $unclean; then
    reset
  fi
  command -v git-lfs >/dev/null 2>&1 || { echo >&2 "\nThis repository is configured for Git LFS but 'git-lfs' was not found on your path. If you no longer wish to use Git LFS, remove this hook by deleting '.git/hooks/pre-push'.\n"; exit 2; }
  # we want the argument splitting
  git lfs pre-push $args
}

# we register it as a trap after lint so that it 1) triggers only if lint-local succeeded
# but 2) only triggers *after* the directory recovery completed
trap lfspre EXIT
